# RabbitMQ for Kubernetes Helm charts

This folder contains Helm charts to deploy our components. The chart `rabbitmq`
is designed to be used by [Container Services Manager (KSM)](https://docs.pivotal.io/ksm/0-7/index.html). The chart `operator` is to deploy our Operator and the Custom Resource Definition (CRD).

## Operator chart

The Operator chart is used to deploy the Operator components. This includes the
`pivotal-rabbitmq-system` namespace and `RabbitmqCluster` CRD. This chart assumes
that `pivotal-rabbitmq-system` namespace **does not exist** and it will **fail to
deploy** if the namespace already exists.

### Structure

The main file is `Chart.yaml`. This contains metadata for the chart itself. You
want to **look at this file** if you want **to change the chart version**. The folder
`templates` has the manifests we use to deploy the Operator and the CRD. Helm orders
these resources before applying them i.e. it will always create the namespace first,
it will not create the deployment before creating the namespace, etc.

```
charts/operator/
├── Chart.yaml
├── templates
│   ├── crd.yaml
│   ├── deployment.yaml
│   ├── _helpers.tpl
│   ├── namespace.yaml
│   └── rbac.yaml
├── values-local.yaml
└── values.yaml
```

The `values.yaml` file contains the configurable properties for this chart. This file
contains the default values for the chart. The users are expected to provide their own
values file or customise the values via the `--set` flag. There is a `.gitignore` file
to ignore `values-local.yaml` for local development.

### Local development

First and foremost, make sure you add PivNet dev registry to your local helm cache.
These are the magic commands to do so:

```bash
helm repo add dev-pivnet \ 
https://dev.registry.pivotal.io/chartrepo/p-rabbitmq-for-kubernetes \ 
--username='some@email.example' --password='Ilovecookies'

helm repo update
```

Second and not essential but huge QoL improvement, install [Helm Push plugin](https://github.com/chartmuseum/helm-push). 
This will allow you to do `helm push charts/operator`.

**Pro tip:** use `h` as an alias to `helm`.

#### Helm template

Any change the `Deployment` template will require also changing the kustomization files in 
`config/default/overlays/helm/`. You might need to add additional patches or resources. 
Any changes to `crd.yaml`, `namespace.yaml` or `rbac.yaml` will also require updating the relevant kustomization files. The templates are generated by `make generate-helm-manifests`.

After doing any desired changes, the chart can be locally tested by `helm template`:

```
helm template charts/operator/ -f charts/operator/values-local.yaml
```

The above command will print all the YAML manifests rendered by `helm`. These
manifests will be applied to the cluster. The output is quite large due to the
CRD. It is advised to redirect the output to either a file or `less`.

#### Helm install

Once you are happy with your changes, or if you test directly in the bunnies cause' you
are a player, you can install the chart using the local files with `helm install`:

```
cd charts/operator
helm -n default install -f values-local.yaml some-name .
```

The option `-n default` is important because Helm keeps track of what has installed via
`Secrets`. For a secret to exist, it needs a namespace; if you are targetting a namespace
which doesn't exist e.g. after `make deploy`, some work, `make destroy`, you will get
an error stating "namespace does not exist". By using the option `-n default`, we avoid
all those errors.

The `values-local.yaml` file should contain customised values for our environment. This
file contains the image reference and the credentials to generate an image pull secret.
You can use the file `values.yaml` for inspiration or `helm show values .`. Please note
that the file `values.yaml` is **not meant to be changed**. This file should contain
the properties we allow to customise and its defaults. For custom values, create and use
a `values-local.yaml`.

#### Helm uninstall

Once local testing is done, or if you want to tear down the deployment, you can use
`helm uninstall` command. It is advised to use this command instead of `make destroy`
to avoid leaving stale Helm secrets. Remember that Helm creates a K8s Secret to keep
track of things?

```
helm -n default uninstall some-name
```

We have to use again the `-n default` to make sure we do not leave stale secrets behind.
This command will delete all the objects initially created by `helm install`, including
CRD and cluster role/binding.

#### Helm list

So you do not remember what name you gave to your deployment? I tend to forget too. Lucky us,
we have `helm list` to make up for our bad memory. There is only one catch: don't forget the
`-n default` option.

```
helm -n default list
```

#### Helm push

After all the changes are done, tested and ready to be pushed to PivNet registry, we have to
update the chart version in `Chart.yaml`. At the time of this writing, we are not coupling
the chart version with the product version. This is not a decision, it was simply easier to
leave them decoupled. It is important to note that changing the chart version is required
before `helm push`; otherwise the command may fail due to an existing version already
present. Once the version has been bumped and the change committed, just run `helm push`
on the local folder:

```
cd charts/
helm push dev-pivnet operator/
```

### Assumptions

Some of these assumptions are implicit in how the chart is written. Most of these opinions are
loosely held.

- There will always be a username/password to authenticate to the registry.
- Image registry requires authentication.
- Namespace `pivotal-rabbitmq-system` does not exist.

## RabbitMQ chart
<!-- TODO: to be written -->
Document these things:

- [ ] Structure
- [ ] Assumptions
- [ ] Workflow to develop
- [ ] Any automation or related CI context

